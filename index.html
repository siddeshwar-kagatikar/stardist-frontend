<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StarDist + UNet ‚Äî Synced Zoom & Pan</title>

  <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom/dist/panzoom.min.js"></script>

  <style>
    :root { --box-size: 340px; }
    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background:#f6f7fb;
      margin:28px;
      text-align:center;
      color:#111827;
    }
    h1 { margin:6px 0 12px; }
    .controls {
      margin-bottom:14px;
      display:flex;
      gap:8px;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
    }
    input[type="file"] { padding:6px; }
    button {
      padding:8px 14px;
      border-radius:8px;
      border:none;
      background:#2563eb;
      color:#fff;
      cursor:pointer;
      font-weight:600;
      transition:background .2s;
    }
    button:hover:not(:disabled) { background:#1e4fd6; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    #images {
      display:flex;
      gap:22px;
      justify-content:center;
      align-items:flex-start;
      margin-top:18px;
      flex-wrap:wrap;
    }
    .panel {
      width:var(--box-size);
      text-align:center;
    }
    .panel h3 {
      margin:8px 0;
      font-size:14px;
      color:#374151;
    }
    .img-wrapper {
      width:var(--box-size);
      height:var(--box-size);
      border-radius:10px;
      overflow:hidden;
      background:#fff;
      box-shadow:0 6px 18px rgba(15,23,42,0.06);
      border:1px solid rgba(15,23,42,0.04);
      display:grid;
      place-items:center;
      position:relative;
    }
    .img-wrapper img {
      display:block;
      width:100%;
      height:100%;
      object-fit:contain;
      user-select:none;
      -webkit-user-drag:none;
      touch-action:none;
      cursor:grab;
      transform-origin:center center;
      will-change: transform;
    }
    .note { margin-top:12px; font-size:13px; color:#6b7280; }
    #loading { display:none; margin-left:8px; color:#6b7280; }
  </style>
</head>
<body>
  <h1>üß† StarDist + UNet ‚Äî Synced Zoom & Pan + Reset</h1>

  <div class="controls">
    <input id="fileInput" type="file" accept="image/*" />
    <button id="goBtn">Segment</button>
    <button id="resetBtn" style="background:#10b981;">Reset View</button>
    <div id="loading">‚è≥ Processing ‚Äî please wait...</div>
  </div>

  <div id="images">
    <div class="panel">
      <h3>Original</h3>
      <div class="img-wrapper">
        <img id="inputImage" src="" alt="Original image" />
      </div>
    </div>

    <div class="panel">
      <h3>StarDist Mask</h3>
      <div class="img-wrapper">
        <img id="maskStar" src="" alt="StarDist mask" />
      </div>
    </div>

    <div class="panel">
      <h3>U-Net Mask</h3>
      <div class="img-wrapper">
        <img id="maskUnet" src="" alt="U-Net mask" />
      </div>
    </div>
  </div>

  <p class="note">
    Use mouse wheel / pinch to zoom, click+drag to pan ‚Äî all images stay in sync.<br>
    Click ‚ÄúReset View‚Äù anytime to restore the full view.
  </p>

  <script>
    const BACKEND_URL = "https://stardist-api.onrender.com/predict"; // update if needed

    const fileInput = document.getElementById('fileInput');
    const goBtn = document.getElementById('goBtn');
    const resetBtn = document.getElementById('resetBtn');
    const loading = document.getElementById('loading');
    const inputImage = document.getElementById('inputImage');
    const maskStar = document.getElementById('maskStar');
    const maskUnet = document.getElementById('maskUnet');

    const allImgs = [inputImage, maskStar, maskUnet];
    let leader = null;
    let lastTransforms = new Map();
    let pans = new Map();

    function makePanzoom(imgEl) {
      try { if (imgEl._pz && typeof imgEl._pz.destroy === 'function') imgEl._pz.destroy(); } catch(e){}
      const pz = Panzoom(imgEl, {
        maxScale: 12,
        minScale: 0.25,
        step: 0.2,
        contain: 'outside'
      });

      imgEl.parentElement.addEventListener('wheel', (ev) => {
        ev.preventDefault();
        pz.zoomWithWheel(ev);
        leader = imgEl;
      }, { passive:false });

      imgEl.addEventListener('pointerdown', () => { leader = imgEl; });
      imgEl._pz = pz;
      pans.set(imgEl, pz);
      return pz;
    }

    function getTransform(el) {
      return window.getComputedStyle(el).transform || 'none';
    }

    function applyTransform(el, t) {
      el.style.transform = t === 'none' ? '' : t;
    }

    function syncLoop() {
      if (leader) {
        const tLead = getTransform(leader);
        for (const img of allImgs) {
          if (img !== leader && lastTransforms.get(img) !== tLead) {
            applyTransform(img, tLead);
            lastTransforms.set(img, tLead);
          }
        }
      } else {
        for (const img of allImgs) {
          lastTransforms.set(img, getTransform(img));
        }
      }
      requestAnimationFrame(syncLoop);
    }

    function resetTransforms() {
      for (const img of allImgs) {
        img.style.transform = '';
        if (img._pz && img._pz.reset) img._pz.reset();
      }
      lastTransforms.clear();
    }

    resetBtn.addEventListener('click', resetTransforms);

    window.addEventListener('DOMContentLoaded', () => {
      for (const img of allImgs) makePanzoom(img);
      requestAnimationFrame(syncLoop);
    });

    goBtn.addEventListener('click', async () => {
      const f = fileInput.files && fileInput.files[0];
      if (!f) { alert('Please choose an image first'); return; }

      try {
        goBtn.disabled = true;
        loading.style.display = 'inline';
        inputImage.src = URL.createObjectURL(f);
        maskStar.src = '';
        maskUnet.src = '';
        resetTransforms();

        const form = new FormData();
        form.append('file', f);
        const res = await fetch(BACKEND_URL, { method:'POST', body: form });
        if (!res.ok) {
          const txt = await res.text();
          throw new Error('Server error ' + res.status + ': ' + txt.slice(0,200));
        }

        // Expect JSON containing base64 URLs
        const data = await res.json();

        // Your backend returns data:image/png;base64,... strings for both masks
        maskStar.src = data.stardist_mask;
        maskUnet.src = data.unet_mask;

      } catch (err) {
        alert('Error: ' + err.message);
      } finally {
        loading.style.display = 'none';
        goBtn.disabled = false;
      }
    });

    for (const img of allImgs) {
      img.addEventListener('load', () => makePanzoom(img));
    }
  </script>
</body>
</html>
